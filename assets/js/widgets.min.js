"use strict";
define("widgets/utils/widgetModel", ["lodash", "compUtils"], function(e, t) {
    function i(e, i) {
        var n = t.compFactory.getCompReactClass(i);
        return n && n.publicState ? n.publicState(null, e) : {}
    }

    function n(e, t) {
        var i = e.getCompType(t),
            n = a(e, t, i);
        return {
            parent: e.getParentId(t),
            type: i,
            state: n,
            layout: e.getCompLayout(t),
            design: e.getCompDesign(t),
            isDisplayed: o(e, t),
            id: e.getCompName(t),
            data: e.getCompData(t),
            fullData: e.getCompFullData(t),
            props: e.getCompProps(t),
            events: []
        }
    }

    function a(t, n, a) {
        var s = {
                data: t.getCompData(n),
                fullData: t.getCompFullData(n),
                props: t.getCompProps(n)
            },
            o = t.getCompState(n);
        return e.isUndefined(o) || e.isEmpty(o) ? i(s, a) : o
    }

    function s(e, t) {
        var i = e.getParentId(t),
            n = e.getCompStructure(i),
            s = a(e, i, n.componentType),
            o = n && s && n.components[s.currentIndex];
        return o && o.id
    }

    function o(e, t) {
        for (var i = t; i;) {
            var n = e.getCompType(i);
            if (n === u || n === c) return i === s(e, i);
            i = e.getParentId(i)
        }
        return e.isDisplayed(t)
    }

    function r(t, i, n) {
        return e.reduce(t, function(t, a) {
            var s = i.getCompConnections(a),
                o = e.map(s, function(t) {
                    var i;
                    return i = "WixCodeConnectionItem" === t.type ? e.assign({}, t, {
                        controllerId: n,
                        config: null
                    }) : e.defaults({}, t, {
                        config: null
                    }), {
                        connection: i,
                        compId: a
                    }
                });
            return t.concat(o)
        }, [])
    }

    function d(t, i, n) {
        var a = r(i, t, n);
        return e(a).groupBy("connection.controllerId").mapValues(function(t) {
            return e(t).groupBy("connection.role").mapValues(function(t) {
                return e(t).keyBy("compId").mapValues("connection.config").value()
            }).value()
        }).value()
    }
    var u = "wysiwyg.viewer.components.BoxSlideShowSlide",
        c = "wysiwyg.viewer.components.StripContainerSlideShowSlide";
    return {
        getCompModel: n,
        getConnectionsModel: d
    }
}), define("widgets/utils/wixCodeRemoteModelService", ["lodash", "platformUtils", "siteUtils", "widgets/utils/widgetModel"], function(e, t, i, n) {
    var a = t.RemoteModelInterface;
    return {
        generateRemoteModelInterface: function(t, s, o, r, d, u, c, p, g) {
            var l = new a(void 0, p);
            return e.forEach(s, function(i) {
                var a = n.getCompModel(t, i),
                    s = e.get(a.data, "widgetId");
                e.assign(a, {
                    publicAPI: d[s]
                }), l.addComponent(i, a)
            }), l.addSiteStructure(o), l.addNavigation(r), l.addConnections(n.getConnectionsModel(t, s, g)), l.addEventTypes(i.constants.ACTION_TYPES), l.addSiteMemberData(c), l.addSessionInfoProp(u), l
        },
        createRemoteModelInterface: function(e, t) {
            return new a(e, t)
        }
    }
}), define("widgets/core/widgetDataHelper", ["lodash"], function(e) {
    return {
        registerWidgetHandler: function(t, i) {
            e.set(t, "widgetHandler", i)
        },
        getWidgetHandler: function(t) {
            return e.get(t, "widgetHandler")
        }
    }
}), define("widgets/core/dataResolvers/pageLinkDataResolver", ["lodash"], function(e) {
    function t(t, i) {
        if ("#" === t) return "#" + i.getMainPageId();
        var n = i.findDataOnMasterPageByPredicate(function(e) {
                return e.pageUriSEO === t.replace("#", "")
            }),
            a = e.get(n, "id", t);
        return e.startsWith(a, "#") ? a : "#" + a
    }

    function i(t, i) {
        var n = e.compact(t.replace(/^#/, "").split("/")),
            a = e.findKey(i.getRouters(), {
                prefix: n[0]
            });
        if (a) return {
            type: "DynamicPageLink",
            routerId: a,
            innerRoute: n.slice(1).join("/")
        }
    }

    function n(t) {
        var i = [],
            a = e.get(t, "link");
        a && i.push(a);
        var s = e.get(t, "linkList");
        return s && (i = i.concat(s)), e.forEach(t, function(t) {
            e.isObject(t) && (i = i.concat(n(t)))
        }), i
    }

    function a(t, i) {
        var n = e.reduce(i.columns, function(e, t) {
                return t.linkPath && e.push(t.linkPath), e
            }, []),
            a = [];
        return n.length > 0 && e.forEach(t.rows, function(t) {
            e.forEach(n, function(i) {
                var n = i + "_linkObj",
                    s = e.get(t, n);
                e.isUndefined(s) || a.push(s)
            })
        }), a
    }

    function s(s, o, r) {
        var d, u = o.getSiteData(),
            c = o.isExperimentOpen("sv_dpages");
        return d = "Grid" === s.type ? a(s, r) : n(s), e.forEach(d, function(n) {
            var a = n.type,
                s = n.pageId;
            if (("PageLink" === a || "AnchorLink" === a) && e.isString(s))
                if (c) {
                    var o = i(n.pageId, u);
                    o ? (e.assign(n, o), delete n.pageId) : n.pageId = t(s, u)
                } else n.pageId = t(s, u)
        }), s
    }
    return {
        resolve: s
    }
}), define("widgets/core/dataResolvers/emptyImageDataResolver", ["lodash"], function(e) {
    function t(t) {
        return t.uri ? t : e.assign({}, t, {
            uri: n
        })
    }

    function i(i) {
        return "Image" === i.type ? t(i) : "ImageList" === i.type ? e.assign({}, i, {
            items: i.items && i.items.map(t)
        }) : i
    }
    var n = "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==";
    return {
        resolve: i
    }
}), define("widgets/core/widgetDataResolvers", ["lodash", "widgets/core/dataResolvers/pageLinkDataResolver", "widgets/core/dataResolvers/emptyImageDataResolver"], function(e, t, i) {
    var n = [t, i];
    return {
        resolve: function(t, i, a) {
            return e.forEach(n, function(e) {
                t = e.resolve(t, i, a)
            }), t
        }
    }
}), define("widgets/core/modelBuilderDataHelper", ["lodash"], function(e) {
    function t(e) {
        return {
            fetchData: e.getDataByQuery.bind(e),
            fetchSiteStructure: e.getSiteStructureForRmi.bind(e),
            fetchNavigationData: e.getNavigationDataRmi.bind(e),
            fetchPublicAPI: e.getPublicAPIDataForRmi.bind(e),
            fetchSessionInfo: e.getSessionInfoForRmi.bind(e),
            fetchSiteMemberData: e.getSMbySiteExtensionInstanceForRmi.bind(e)
        }
    }

    function i(t) {
        return e.includes(a, e.get(t, "type")) ? e.get(t, "isPopup") ? n.POPUP : n.PAGE : n.UNKNOWN
    }
    var n = {
            PAGE: "Page",
            POPUP: "Popup",
            UNKNOWN: "Unknown"
        },
        a = ["Page", "AppPage"];
    return {
        getApi: t,
        getWidgetType: i,
        WIDGET_TYPES: n
    }
}), define("widgets/core/modelBuilder", ["lodash", "coreUtils", "widgets/utils/wixCodeRemoteModelService", "widgets/core/modelBuilderDataHelper"], function(e, t, i, n) {
    function a(t, n, a, s, o, r, d, u) {
        return e.mapValues(n, function(e, n) {
            return i.generateRemoteModelInterface(t, e, s(), o(), r(), d(), u(), a, n)
        })
    }

    function s(t, i) {
        var n = [u.PAGES_CONTAINER_ID, u.SITE_PAGES_ID],
            a = i(t, t);
        return e(a).omit([u.SITE_STRUCTURE_ID]).keys().difference(n).value()
    }

    function o(e, t) {
        var i = t(e, e);
        return n.getWidgetType(i) === n.WIDGET_TYPES.PAGE
    }

    function r(i, n, a) {
        var r = t.siteConstants.MASTER_PAGE_ID,
            d = s(r, n),
            u = e.without(i, r);
        return e.transform(u, function(e, t) {
            e[t] = s(t, n), o(t, a) && (e[t] = e[t].concat(d))
        }, {})
    }

    function d(e, t, i, s, o) {
        var d = n.getApi(t);
        return a(e, r(i, o, d.fetchData), s, d.fetchSiteStructure, d.fetchNavigationData, d.fetchPublicAPI, d.fetchSessionInfo, d.fetchSiteMemberData)
    }
    var u = t.siteConstants;
    return {
        build: d
    }
}), define("widgets/messages/messageBuilder", [], function() {
    function e(e, t) {
        return {
            type: "load_user_code",
            widgets: e,
            rootIds: t
        }
    }

    function t(e, t, i, n) {
        return {
            type: "load_widgets",
            sdkParameters: {
                referrer: "undefined" == typeof window ? "" : window.document.referrer
            },
            widgets: e,
            rootIds: i,
            routersMap: t || {},
            popupContexts: n || {}
        }
    }

    function i(e) {
        return {
            type: "init_widgets",
            controllers: e
        }
    }

    function n(e, t) {
        return {
            type: "start_widgets",
            contexts: e,
            siteInfo: t
        }
    }

    function a(e) {
        return {
            intent: "WIX_CODE",
            type: "trigger_onRender",
            contextId: e
        }
    }

    function s(e, t, i) {
        return {
            intent: "WIX_CODE",
            type: "wix_code_run_user_function",
            contextId: e,
            callbackId: t.callbackId,
            compId: t.compId,
            event: i
        }
    }

    function o(e) {
        return {
            type: "stop_widgets",
            widgetIds: e
        }
    }

    function r(e, t) {
        return {
            type: "update",
            contextId: e,
            updates: t
        }
    }

    function d(e, t) {
        return {
            contextId: e,
            type: "update_site_member",
            updates: t
        }
    }

    function u(e, t) {
        return {
            contextId: e,
            type: "update_session_info",
            updates: t
        }
    }
    return {
        loadWidgetsMessage: t,
        loadUserCodesMessage: e,
        initWidgetsMessage: i,
        startWidgetsMessage: n,
        stopWidgetsMessage: o,
        updateWidgetMessage: r,
        updateSiteMemberData: d,
        updateSessionInfo: u,
        triggerOnRenderMessage: a,
        triggerUserFunctionMessage: s
    }
}), define("widgets/core/RemoteWidgetHandlerProxy", ["lodash", "core", "utils", "widgets/core/widgetDataResolvers", "widgets/core/modelBuilder", "widgets/messages/messageBuilder"], function(e, t, i, n, a, s) {
    function o(t, i, n, a) {
        ({
            data: this._runtimeDal.setCompData.bind(this._runtimeDal),
            design: this._runtimeDal.setCompDesign.bind(this._runtimeDal),
            props: this._runtimeDal.setCompProps.bind(this._runtimeDal),
            layout: this._runtimeDal.updateCompLayout.bind(this._runtimeDal),
            registerEvent: r.bind(this)
        })[i](t, n), e.isFunction(this._onUpdateCallback) && this._onUpdateCallback(a)
    }

    function r(e, t) {
        var i = {
            action: {
                type: "comp",
                name: t.eventType,
                sourceId: e
            },
            behavior: {
                type: "widget",
                targetId: t.contextId,
                params: {
                    callbackId: t.callbackId,
                    compId: e
                },
                name: "runCode"
            }
        };
        this._runtimeDal.addActionsAndBehaviors(e, i)
    }

    function d(e) {
        var t = this._siteAPI.getSiteDataAPI().document,
            i = t.getAllCompsUnderRoot.bind(t);
        return a.build(this._siteAPI.getRuntimeDal(), this._siteAPI.getSiteData(), e, o.bind(this), i)
    }

    function u() {
        return {
            deviceType: this._siteAPI.getSiteData().isMobileView() ? "mobile" : "desktop"
        }
    }

    function c(e, t) {
        var i = function() {
            this.isWidgetReady(e.contextId) ? this.handleCommand(e, t) : c.call(this, e, t)
        };
        this._actionQueue.addItem(i.bind(this))
    }

    function p(e) {
        if (!this._isFlushingPendingCommands) {
            var t = this;
            this._isFlushingPendingCommands = !0;
            var n = function() {
                t._isFlushingPendingCommands = !1, t._actionQueue.flush(), g(t._commandsFlushListeners)
            };
            e ? n() : i.animationFrame.request(n)
        }
    }

    function g(t) {
        e.forEach(t, function(e) {
            return e()
        })
    }

    function l(e, t) {
        this._runtimeDal = e.getRuntimeDal(), this._siteAPI = e, this._remoteModelInterfaces = {}, this._onUpdateCallback = t, this._receivedChanges = void 0, this._isFlushingPendingCommands = !1, this._readyWidgets = {}, this._commandsFlushListeners = [], this._actionQueue = e.getSiteDataAPI().getActionQueue()
    }

    function f(e) {
        return this._remoteModelInterfaces[e]
    }

    function h(t) {
        var i = e.merge(e.pick(t, "item"), e.pickBy(t, e.negate(e.isObject)));
        return i.nativeEvent = e.pickBy(t.nativeEvent, e.negate(e.isObject)), t.data && (i.data = t.data), i
    }

    function m(t, i, a, s) {
        var o = e.assign({}, i.getCompData(a), s),
            r = i.getCompProps(a);
        return n.resolve(o, t, r)
    }
    var v = {
            State: "stateChanged",
            Data: "dataChanged",
            Design: "designChanged",
            Props: "propsChanged",
            EventRegister: "registerEvent",
            Layout: "layoutChanged",
            Behavior: "executeBehavior"
        },
        I = {
            WidgetReady: "widget_ready"
        };
    return l.prototype.initWidgets = function(e) {
        var t = s.initWidgetsMessage(e);
        this._sendMessage(t)
    }, l.prototype.startWidgets = function(t) {
        if (!e.isEmpty(t)) {
            e.assign(this._remoteModelInterfaces, d.call(this, t));
            var i = e.mapValues(this._remoteModelInterfaces, function(e) {
                    return e.toJson()
                }),
                n = u.call(this),
                a = s.startWidgetsMessage(e.pick(i, t), n);
            this._sendMessage(a)
        }
    }, l.prototype.loadUserCode = function(e, t) {
        var i = s.loadUserCodesMessage(e, t);
        this._sendMessage(i)
    }, l.prototype.loadWidgets = function(t, i) {
        this.loadUserCode(t, i);
        var n = e(i).transform(function(e, t) {
                e[t] = this._runtimeDal.getPopupContext(t)
            }.bind(this), {}).omitBy(e.isUndefined).value(),
            a = s.loadWidgetsMessage(t, this._siteAPI.getSiteData().getRouters(), i, n);
        this._sendMessage(a)
    }, l.prototype.getActiveWidgetIds = function() {
        return e.keys(this._remoteModelInterfaces)
    }, l.prototype.stopWidgets = function(t) {
        if (!e.isEmpty(t)) {
            e.forEach(t, function(e) {
                delete this._remoteModelInterfaces[e], this._readyWidgets[e] = !1
            }.bind(this));
            var i = s.stopWidgetsMessage(t);
            this._sendMessage(i)
        }
    }, l.prototype.stopAllWidgets = function() {
        this.stopWidgets(e.keys(this._remoteModelInterfaces))
    }, l.prototype.updateComponent = function(e) {
        this._sendMessage(e)
    }, l.prototype.handleWidgetUpdate = function(t) {
        var i = e(t).keys().head(),
            n = e.pickBy(this._remoteModelInterfaces, function(t) {
                return e.has(t.toJson(), ["components", i])
            }),
            a = e.find(e.find(t));
        if (!e.isEmpty(n) && !e.isEqual(this._receivedChanges, a)) {
            var o = e(n).keys().head();
            n[o].updateModel(t);
            var r = s.updateWidgetMessage(o, t);
            this._sendMessage(r)
        }
    }, l.prototype.handleSiteMemberUpdate = function(t) {
        e.forEach(this._remoteModelInterfaces, function(e, i) {
            e.addSiteMemberData(t);
            var n = s.updateSiteMemberData(i, t);
            this._sendMessage(n)
        }.bind(this))
    }, l.prototype.handleSvSessionUpdate = function(t) {
        e.forEach(this._remoteModelInterfaces, function(e, i) {
            e.addSessionInfoProp(t);
            var n = s.updateSessionInfo(i, {
                svSession: t
            });
            this._sendMessage(n)
        }.bind(this))
    }, l.prototype.handleRemoteMessage = function(t) {
        switch (t.type) {
            case I.WidgetReady:
                if (f.call(this, t.widgetId)) {
                    this._readyWidgets[t.widgetId] = !0;
                    var i = function() {
                        this._commandsFlushListeners = e.without(this._commandsFlushListeners, i), this._siteAPI.forceUpdate()
                    }.bind(this);
                    this._commandsFlushListeners.push(i), p.call(this)
                }
        }
    }, l.prototype.onCommand = function(e, t) {
        c.call(this, e, t), this.isWidgetReady(e.contextId) && p.call(this, e.command === v.EventRegister)
    }, l.prototype.handleCommand = function(e, i) {
        this._receivedChanges = e.data;
        var n = this._remoteModelInterfaces[e.contextId];
        if (n) {
            switch (e.command) {
                case v.State:
                    n.setState(e.compId, e.data);
                    break;
                case v.Data:
                    e.data = m(this._siteAPI, this._runtimeDal, e.compId, e.data), n.setData(e.compId, e.data);
                    break;
                case v.Design:
                    n.setDesign(e.compId, e.data);
                    break;
                case v.Layout:
                    n.setLayout(e.compId, e.data);
                    break;
                case v.Props:
                    n.setProps(e.compId, e.data, i);
                    break;
                case v.EventRegister:
                    n.registerEvent(e.contextId, e.compId, e.data.eventType, e.data.callbackId);
                    break;
                case v.Behavior:
                    var a = e.data,
                        s = {
                            group: "command",
                            callback: i
                        };
                    t.behaviorsService.handleBehaviors(this._siteAPI, [a], s, a.type)
            }
            this._receivedChanges = void 0
        }
    }, l.prototype.handleEvent = function(e, t, i, n) {
        var a;
        switch (t) {
            case "runCode":
                a = s.triggerUserFunctionMessage(e, i, h(n));
                break;
            case "onRendered":
                a = s.triggerOnRenderMessage(e)
        }
        this._sendMessage(a)
    }, l.prototype.isWidgetReady = function(e) {
        return !!this._readyWidgets[e]
    }, l.prototype._sendMessage = function(e) {
        this._siteAPI.getWixCodeAppApi().sendMessage(e)
    }, l.prototype.registerCommandsFlushedListener = function(t) {
        if (!e.isFunction(t)) throw new TypeError("The callback provided is not a function.");
        this._commandsFlushListeners.push(t)
    }, l
}), define("widgets/core/widgetService", ["lodash", "utils", "widgets/utils/widgetModel", "widgets/core/widgetDataHelper", "widgets/core/RemoteWidgetHandlerProxy", "coreUtils", "wixCodeInit"], function(e, t, i, n, a, s, o) {
    function r(e) {
        return !!e.getRenderFlag("initWixCode")
    }

    function d(e, t) {
        P(e, new a(e, t))
    }

    function u(t, i, n) {
        var a = {
                dataChange: "data",
                propsChange: "props",
                stateChange: "state",
                layoutChange: "layout"
            },
            s = e.zipObject([a[n.type]], [n.value]),
            o = e.zipObject([i], [s]);
        M(t).handleWidgetUpdate(o)
    }

    function c(t, n, a) {
        if (e.includes(t.getAllRenderedRootIds(), n)) {
            var s = t.getRuntimeDal(),
                o = t.getSiteDataAPI().document.getAllCompsUnderRoot(n, a),
                r = e(o).omit(["masterPage"]).mapValues(function(e) {
                    return i.getCompModel(s, e.id)
                }).value();
            M(t).handleWidgetUpdate(r)
        }
    }

    function p(e, t, i) {
        c(e, t, i)
    }

    function g(e) {
        var t = e.getSiteData().getSMbySiteExtensionInstanceForRmi();
        M(e).handleSiteMemberUpdate(t)
    }

    function l(e) {
        var t = e.getSiteData().getSvSession();
        M(e).handleSvSessionUpdate(t)
    }

    function f(t, i, n) {
        var a = e.difference(t, e.map(i, "rootId"));
        return e.isEmpty(a) || (i = E(n, i, t), U(n, a)), i
    }

    function h(t, i) {
        return e.map(t, function(t) {
            return e.includes(i, t.rootId) ? e.assign(t, {
                started: !0
            }) : t
        })
    }

    function m(i, n, a) {
        var s = i.getSiteData(),
            r = M(i);
        a = e.without(a, t.siteConstants.MASTER_PAGE_ID);
        var d = o.appsUtils.getApplications(s.getClientSpecMap(), a, s);
        if (e.isEmpty(d)) return n;
        n = f(a, n, i);
        var u = e(n).reject({
            started: !0
        }).map("rootId").value();
        return e.isEmpty(u) ? n : (r.startWidgets(u), n = h(n, u))
    }

    function v(t, i) {
        var n = e.reject(t, function(t) {
            return e.includes(i, t.rootId)
        });
        return e.map(n, "rootId")
    }

    function I(t, i) {
        var n = e.filter(t, function(t) {
            return e.includes(i, t.rootId)
        });
        return e.map(n, "rootId")
    }

    function y(t, i, n) {
        var a = M(t);
        return e.isEmpty(n) || e.isEmpty(i) ? i : (a.stopWidgets(n), e.reject(i, function(t) {
            return e.includes(n, t.rootId)
        }))
    }

    function _(t, i) {
        var n = e.without(t.getRootIdsWhichShouldBeRendered(), "masterPage");
        return r(t) ? (i = y(t, i, v(i, n)), m(t, i, n)) : y(t, i, n)
    }

    function A(i, n) {
        var a = [{
            id: i,
            json: n.getPageData(i)
        }];
        if (e.get(n.getDataByQuery(i), "isPopup")) return a;
        var s = t.siteConstants.MASTER_PAGE_ID;
        return a.concat({
            id: s,
            json: n.getPageData(s)
        })
    }

    function C(t, i) {
        return e(t).transform(function(t, i) {
            e.assign(t, e.get(i, "data.connections_data"))
        }, {}).values().flatMap(function(t) {
            var n = i.resolveData(t, null, i.dataTypes.CONNECTIONS);
            return e.get(n, "items")
        }).groupBy("controllerId").value()
    }

    function S(e) {
        return "platform.components.AppController" === e.componentType
    }

    function w(t, i) {
        var n = C(e.map(t, "json"), i);
        return e(t).map(function(t) {
            return {
                rootId: t.id,
                controllers: s.dataUtils.getAllCompsInStructure(e.get(t, "json.structure"), !1, S)
            }
        }).flatMap(function(t) {
            return e.map(t.controllers, function(a) {
                var s = a.dataQuery.replace("#", "");
                return e.omitBy(e.merge({
                    controllerBehaviors: e.get(i.getDataByQuery(a.behaviorQuery, t.rootId, i.dataTypes.BEHAVIORS), "items", []),
                    controllerData: i.getDataByQuery(s, t.rootId),
                    controllerId: s,
                    compId: a.id
                }, {
                    connections: e.get(n, s)
                }), e.isUndefined)
            })
        }).value()
    }

    function D(t) {
        return e(t).groupBy(function(t) {
            return e.get(t, "controllerData.applicationId")
        }).mapValues(function(t) {
            return e(t).groupBy("controllerId").mapValues(function(t) {
                return e.pick(e.head(t), ["controllerData", "controllerBehaviors", "connections", "compId"])
            }).value()
        }).value()
    }

    function P(e, t) {
        var i = e.getSiteData().widgetsStore;
        n.registerWidgetHandler(i, t)
    }

    function M(e) {
        var t = e.getSiteData().widgetsStore;
        return n.getWidgetHandler(t)
    }

    function R(i, n) {
        return e(i).without(t.siteConstants.MASTER_PAGE_ID).filter(n.getPageTitle.bind(n)).value()
    }

    function b(t, i) {
        var n = t.getSiteData(),
            a = R(i, n),
            s = o.appsUtils.getUserCodeDefinitions(n.getClientSpecMap(), a, n);
        e.isEmpty(s) || M(t).loadUserCode(s, a)
    }

    function E(t, i, n) {
        var a = t.getSiteData(),
            s = R(n, a);
        if (e(s).difference(e.map(i, "rootId")).thru(e.isEmpty).value()) return i;
        var r = o.appsUtils.getApplications(a.getClientSpecMap(), s, a);
        if (e.isEmpty(r)) return i;
        M(t).loadWidgets(r, s);
        var d = e.map(s, function(e) {
            return {
                rootId: e
            }
        });
        return i.concat(d)
    }

    function W(e, t) {
        return D(w(A(t, e), e))
    }

    function U(i, n) {
        var a = i.getSiteData(),
            s = e(n).without(t.siteConstants.MASTER_PAGE_ID).transform(function(e, t) {
                e[t] = W(a, t)
            }, {}).omitBy(e.isEmpty).value();
        e.isEmpty(s) || M(i).initWidgets(s)
    }

    function k(t, i, n) {
        var a = I(i, n);
        return e(t.getAllRenderedRootIds()).intersection(a).thru(e.isEmpty).value() ? i : y(t, i, a)
    }

    function B(e) {
        return e.getWixCodeAppApi()
    }

    function T(e, t) {
        B(e).registerMessageHandler(t)
    }

    function x(e, t) {
        B(e).registerMessageModifier(t)
    }

    function F(e, t) {
        B(e).sendMessage(t)
    }
    return {
        getWidgetHandler: M,
        syncAppsState: _,
        handleRuntimeDalCompChange: u,
        handleDisplayedJsonUpdate: p,
        handleSiteMemberUpdate: g,
        handleSvSessionUpdate: l,
        updateCompsUnderRoot: c,
        createAndRegisterWidgetHandler: d,
        loadUserCode: b,
        loadApps: E,
        initApps: U,
        stopApps: k,
        getControllersToInit: W,
        registerWidgetMessageHandler: T,
        registerWidgetMessageModifier: x,
        sendMessageToWidget: F
    }
}), define("widgets/core/WidgetAspect", ["lodash", "coreUtils", "widgets/core/widgetDataHelper", "widgets/core/widgetService", "widgets/core/modelBuilderDataHelper"], function(e, t, i, n, a) {
    function s(t) {
        this._siteAPI = t, this._loadedAppsRoots = [], this._updateSiteCallBacks = [], this._updating = !1, n.createAndRegisterWidgetHandler(t, this.updateSite.bind(this)), this._siteAPI.isExperimentOpen("sv_platform1") && (this._siteAPI.registerToSiteWillMount(o.bind(this)), this._siteAPI.registerToSiteWillUpdate(o.bind(this))), this._siteAPI.getRuntimeDal().registerChangeListener(e.partial(n.handleRuntimeDalCompChange, this._siteAPI)), this._siteAPI.getSiteDataAPI().registerDisplayedJsonUpdateCallback(e.partial(n.handleDisplayedJsonUpdate, this._siteAPI)), this._siteAPI.registerToFakeModeChange(e.partial(n.updateCompsUnderRoot, this._siteAPI)), this._siteAPI.registerClientSpecMapUpdateCallback(e.partial(n.handleSiteMemberUpdate, this._siteAPI)), this._siteAPI.registerToSvSessionChange(e.partial(n.handleSvSessionUpdate, this._siteAPI)), this.getWidgetHandler = e.partial(n.getWidgetHandler, this._siteAPI)
    }

    function o() {
        this._loadedAppsRoots = n.syncAppsState(this._siteAPI, this._loadedAppsRoots)
    }

    function r(t, i, n) {
        return "masterPage" !== t ? t : e.find(i, function(e) {
            var t = n.getDataByQuery(e);
            return a.getWidgetType(t) === a.WIDGET_TYPES.PAGE
        })
    }
    return s.prototype.init = function() {
        this._loadedAppsRoots = [], this._updateSiteCallBacks = [], this._updating = !1
    }, s.prototype.updateSite = function(i) {
        if (i && this._updateSiteCallBacks.push(i), !this._updating) {
            this._updating = !0;
            var n = this;
            t.animationFrame.request(function() {
                n._updating = !1, e.invokeMap(n._updateSiteCallBacks, e.call), n._updateSiteCallBacks = []
            })
        }
    }, s.prototype.allContextsReady = function() {
        return e(this._loadedAppsRoots).map("rootId").every(this.isContextReady.bind(this))
    }, s.prototype.isContextReady = function(t) {
        var n = this._siteAPI.getSiteData(),
            a = n.widgetsStore,
            s = i.getWidgetHandler(a),
            o = e.map(this._loadedAppsRoots, "rootId"),
            d = r(t, o, n);
        return !!e.isEmpty(this._loadedAppsRoots) || e.includes(o, d) && s.isWidgetReady(d)
    }, s.prototype.loadUserCode = function(e) {
        n.loadUserCode(this._siteAPI, e)
    }, s.prototype.loadApps = function(e) {
        this._siteAPI.getRenderFlag("initWixCode") && (n.loadUserCode(this._siteAPI, e), this._loadedAppsRoots = n.loadApps(this._siteAPI, this._loadedAppsRoots, e))
    }, s.prototype.initApps = function(e) {
        this._siteAPI.getRenderFlag("initWixCode") && n.initApps(this._siteAPI, e)
    }, s.prototype.stopApps = function(e) {
        this._loadedAppsRoots = n.stopApps(this._siteAPI, this._loadedAppsRoots, e)
    }, s.prototype.restartApps = function() {
        if (!e.isEmpty(this._loadedAppsRoots)) {
            var t = e.map(this._loadedAppsRoots, "rootId");
            this.stopApps(t), this.loadApps(t), this.initApps(t)
        }
    }, s
}), define("widgets/behaviors/widgetBehaviorHandler", ["lodash"], function(e) {
    function t(t, i, n) {
        var a = i.getSiteAspect("WidgetAspect").getWidgetHandler();
        e.forEach(t, function(e) {
            a.handleEvent(e.targetId, e.name, e.params, n)
        })
    }

    function i(t) {
        var i = e.at(t, n);
        return i.push(t.params.callbackId), i.push(t.params.compId), i.join(",")
    }
    var n = ["type", "name", "targetId"];
    return {
        handle: t,
        getUniqueIdentifier: i
    }
}), define("widgets/behaviors/widgetBehaviorPreprocessor", ["lodash"], function(e) {
    function t(e, t) {
        var i = e.getRuntimeDal().getPageId(t);
        return i ? "masterPage" === i ? e.getSiteData().getFocusedRootId() : i : null
    }

    function i(i, n, a) {
        return e.assign({}, i, {
            targetId: t(a, n.sourceId)
        })
    }
    return i
}), define("widgets", ["core", "widgets/utils/wixCodeRemoteModelService", "widgets/core/WidgetAspect", "widgets/core/widgetDataHelper", "widgets/core/modelBuilder", "widgets/behaviors/widgetBehaviorHandler", "widgets/behaviors/widgetBehaviorPreprocessor", "widgets/messages/messageBuilder", "widgets/utils/widgetModel", "widgets/core/widgetService"], function(e, t, i, n, a, s, o, r, d, u) {
    return e.behaviorHandlersFactory.registerHandler("widget", s), e.behaviorHandlersFactory.registerBehaviorPreprocessor("widget", o), e.siteAspectsRegistry.registerSiteAspect("WidgetAspect", i), {
        wixCodeRemoteModelService: t,
        widgetDataHelper: n,
        messageBuilder: r,
        modelBuilder: a,
        widgetModel: d,
        widgetService: u
    }
});
//# sourceMappingURL=widgets.min.js.map